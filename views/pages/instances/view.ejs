<%- include('../../partials/header') %>
<div class="padded">
    <h1>Assistants</h1>
    <div id="res" class="alert"></div>
    <div style="text-align: center;">
        <a href="/instances/add"><button>New Assistant</button></a>
    </div>
    <br/><br/>
    <table id="instanceTable" class="display" style="width:100%"></table>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.7.0/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.7.0/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.7.0/js/buttons.print.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/1.13.5/css/buttons.dataTables.min.css">

<style>
    /* Card view styles */
    .cards-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
    }
    .card {
        border: 1px solid #ccc;
        padding: 20px;
        border-radius: 5px;
        width: 250px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    .card h3 {
        margin: 0;
    }
    table.cards thead {
        display: none;
    }
    /* Base styling for the table rows */
    table.cards tbody tr {
        display: flex;
        flex-wrap: wrap;
        width: 450px;
        height: 300px;
        border: 1px solid white;
        cursor: pointer;
        margin: 1em;
        background-size: 100% auto; /* Scale to fit horizontally */
        background-repeat: no-repeat; /* Prevent repeating */
        background-position: center;  /* Center the background image */
    }

    /* Specific background images for the first 11 rows, repeating every 11 rows */
    table.cards tbody tr:nth-child(11n + 1) {
        background-image: url("/images/assistants/1.webp");
    }

    table.cards tbody tr:nth-child(11n + 2) {
        background-image: url("/images/assistants/2.webp");
    }

    table.cards tbody tr:nth-child(11n + 3) {
        background-image: url("/images/assistants/3.webp");
    }

    table.cards tbody tr:nth-child(11n + 4) {
        background-image: url("/images/assistants/4.webp");
    }

    table.cards tbody tr:nth-child(11n + 5) {
        background-image: url("/images/assistants/5.webp");
    }

    table.cards tbody tr:nth-child(11n + 6) {
        background-image: url("/images/assistants/6.webp");
    }

    table.cards tbody tr:nth-child(11n + 7) {
        background-image: url("/images/assistants/7.webp");
    }

    table.cards tbody tr:nth-child(11n + 8) {
        background-image: url("/images/assistants/8.webp");
    }

    table.cards tbody tr:nth-child(11n + 9) {
        background-image: url("/images/assistants/9.webp");
    }

    table.cards tbody tr:nth-child(11n + 10) {
        background-image: url("/images/assistants/10.webp");
    }

    table.cards tbody tr:nth-child(11n + 11) {
        background-image: url("/images/assistants/11.webp");
    }

    table.cards tbody tr td {
        display: none;
        border-top: none !important;
    }

    table.cards tbody tr td.name,
    table.cards tbody tr td.description {
        display: block; /* Display the long name and edit columns */
        position: relative; /* Position these elements relative to the card */
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 5px 10px;
        border-radius: 8px;
        width: max-content;
        z-index: 10;
        height: max-content;
        margin: 0.5em;
    }
    table.cards tbody tr td.description {
        position: absolute;
        bottom: 80px;
        width: 410px;
        height: 60px;
    }



</style>

<script>
    let firstLoad = true;
    $(document).ready(function () {
        const instanceTable = $('#instanceTable').DataTable({
            ajax: {
                url: '/instances/',
                dataSrc: '',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('Accept', 'application/json');
                }
            },
            columns: [
                { data: 'name', className: 'name', title: 'Name', defaultContent: '', width: '10%'},
                { data: 'description', className: 'description', title: 'Description', defaultContent: '', width: '30%'},
                {
                    data: 'createdAt',
                    title: 'Created Date',
                    width: '12%',
                    render: function(data, type, row) {
                        var date = new Date(data);
                        return date.toLocaleString();
                    }
                },
                { data: 'public', title: 'Public', defaultContent: '', width: '10%' },
                {
                    title: 'Actions',
                    render: function (data, type, row) {
                        return '<button class="editBtn" data-instanceid="' + row._id + '">Edit</button>' +
                               '<button class="deleteBtn" data-instanceid="' + row._id + '">Delete</button>' +
                               '<button class="manageSourcesBtn" data-instanceid="' + row._id + '">Manage Sources</button>' +
                               '<button class="manageSharesBtn" data-instanceid="' + row._id + '">Share</button>' +
                               '<button class="chatBtn" data-instanceid="' + row._id + '">Chat</button>' +
                               '<button class="ratingsBtn" data-instanceid="' + row._id + '">Ratings report</button>';
                    },
                    width: '50%'
                }
            ],
            order: [[0, 'asc']],
            dom: 'frtipB',
            buttons: [
                'copy', 'csv', {
                    'text': '<i class="fa viewSwitch fa-table fa-fw" aria-hidden="true"></i>',
                    'action': function (e, dt, node) {
                        firstLoad = false;
                        const tableNode = $(dt.table().node());
                        const isCardsView = tableNode.hasClass('cards');

                        tableNode.toggleClass('cards');

                        if (isCardsView) {
                            tableNode.removeClass('cards');
                            $('.viewSwitch', node).removeClass('fa-table').addClass('fa-id-badge');
                            dt.draw('page');
                        } else {
                            tableNode.addClass('cards');
                            $('.viewSwitch', node).removeClass('fa-id-badge').addClass('fa-table');
                            dt.draw('page');
                        }

                        dt.draw('page');
                    },
                    'className': 'btn-sm',
                    'attr': {
                        'title': 'Change views',
                    }
                }
            ],
            language: {
                searchPlaceholder: "Search"
            },
            drawCallback: function (settings) {
                // Add 'cards' class by default on table initialization
                if (!$(this.api().table().node()).hasClass('cards') && firstLoad) {
                    $(this.api().table().node()).addClass('cards');
                }
            },
            autoWidth: false // Disable automatic column sizing
        });

        // Click event listener for row clicks
        $('#instanceTable tbody').on('click', 'tr', function () {
            // Check if the table is in cards view (has 'cards' class)
            if ($('#instanceTable').hasClass('cards')) {
                const rowData = instanceTable.row(this).data();
                if (rowData && rowData._id) {
                    window.location.href = '/instances/' + rowData._id;
                }
            }
        });

        // Existing functionality for buttons (edit, delete, manage)
        $('#instanceTable').on('click', '.editBtn', function () {
            var instanceId = $(this).data('instanceid');
            window.location.href = '/instances/' + instanceId + '/edit';
        });

        $('#instanceTable').on('click', '.deleteBtn', function () {
            var instanceId = $(this).data('instanceid');
            if (confirm('Are you sure you want to delete this instance?')) {
                $('#res').html('<p>Deleting, please wait.</p>');
                $.ajax({
                    url: '/instances/' + instanceId,
                    type: 'DELETE',
                    success: function (result) {
                        $('#res').html('<p>Instance deleted successfully.</p>');
                        instanceTable.ajax.reload();
                        setTimeout(function () {
                            $('#res').html('');
                        }, 5000);
                    },
                    error: function (xhr, status, error) {
                        $('#res').html('<p>Error deleting instance: ' + error + '</p>');
                        setTimeout(function () {
                            $('#res').html('');
                        }, 5000);
                    }
                });
            }
        });
    });
</script>
<%- include('../../partials/footer') %>
