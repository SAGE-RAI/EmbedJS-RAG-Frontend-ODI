<!-- views/pages/instances/view.ejs -->
<%- include('../../partials/header-admin') %>
<style>
    /* Add your custom styles here */
</style>
<h1>Instances</h1>
<div id="res" class="alert"></div>

<a href="/instances/add"><button>Add Instance</button></a>
<br/><br/>
<table id="instanceTable" class="display" style="width:100%"></table>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.7.0/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.7.0/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.7.0/js/buttons.print.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/1.13.5/css/buttons.dataTables.min.css">

<script>
    $(document).ready(function () {
        const instanceTable = $('#instanceTable').DataTable({
            ajax: {
                url: '/instances/',
                dataSrc: '',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('Accept', 'application/json');
                }
            },
            columns: [
                { data: 'name', title: 'Name', defaultContent: '' },
                { data: 'description', title: 'Description', defaultContent: '' },
                { data: 'dbName', title: 'Database Name', defaultContent: '' },
                {
                    data: 'createdAt',
                    title: 'Created Date',
                    width: '12%',
                    render: function(data, type, row) {
                        var date = new Date(data);
                        return date.toLocaleString();
                    }
                },
                { data: 'public', title: 'Public', defaultContent: '', width: '5%' },
                {
                    title: 'Actions',
                    render: function (data, type, row) {
                        return '<button class="editBtn" data-instanceId="' + row._id + '">Edit</button>' +
                               '<button class="deleteBtn" data-instanceId="' + row._id + '">Delete</button>' +
                               '<button class="manageSourcesBtn" data-instanceId="' + row._id + '">Manage Sources</button>' +
                               '<button class="chatBtn" data-instanceId="' + row._id + '">Chat</button>';
                    }
                }
            ],
            order: [[0, 'asc']],
            dom: 'Bfrtip',
            buttons: [
                'copy', 'csv', 'excel', 'pdf', 'print'
            ]
        });

        $('#instanceTable').on('click', '.editBtn', function () {
            var instanceId = $(this).data('instanceId');
            window.location.href = '/instances/' + instanceId + '/edit';
        });

        $('#instanceTable').on('click', '.deleteBtn', function () {
            var instanceId = $(this).data('instanceId');
            if (confirm('Are you sure you want to delete this RAG instance?')) {
                $('#res').html('<p>Deleting, please wait.</p>');
                $.ajax({
                    url: '/instances/' + instanceId,
                    type: 'DELETE',
                    success: function (result) {
                        $('#res').html('<p>RAG instance deleted successfully.</p>');
                        instanceTable.ajax.reload();
                        setTimeout(function () {
                            $('#res').html('');
                        }, 5000);
                    },
                    error: function (xhr, status, error) {
                        $('#res').html('<p>Error deleting RAG instance: ' + error + '</p>');
                        setTimeout(function () {
                            $('#res').html('');
                        }, 5000);
                    }
                });
            }
        });

        $('#instanceTable').on('click', '.manageSourcesBtn', function () {
            var instanceId = $(this).data('instanceId');
            console.log('/instances/' + instanceId + '/sources');
            window.location.href = '/instances/' + instanceId + '/sources';
        });

        $('#instanceTable').on('click', '.chatBtn', function () {
            var instanceId = $(this).data('instanceId');
            window.location.href = '/instances/' + instanceId + '/conversations';
        });
    });
</script>
<%- include('../../partials/footer-admin') %>